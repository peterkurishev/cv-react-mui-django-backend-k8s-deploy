apiVersion: apps/v1
kind: Deployment
metadata:
  name: django-react-app
spec:
  replicas: {{ .Values.django.replicas }}
  selector:
    matchLabels:
      app: django-react-app
  template:
    metadata:
      labels:
        app: django-react-app
    spec:
      initContainers:
        - name: init-react-static
          image: busybox:1.35
          command: ['sh', '-c', 'mkdir -p /app-static && cp -R /config-files/* /app-static/']
          volumeMounts:
            - name: react-static
              mountPath: /config-files
            - name: shared-static
              mountPath: /app-static

      containers:
        # Django-контейнер
        - name: django-app
          image: {{ .Values.django.image }}
          ports:
            - containerPort: {{ .Values.django.port }}
          env:
            {{- range $key, $value := .Values.django.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
          volumeMounts:
            - name: shared-static
              mountPath: /app/static  # Куда монтируем статику React в Django

        # Nginx для React-статики + прокси к Django
        - name: nginx
          image: {{ .Values.nginxImage }}
          ports:
            - containerPort: 80
          volumeMounts:
            - name: shared-static
              mountPath: /usr/share/nginx/html/static  # Статика React
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf

      volumes:
        - name: react-static
          configMap:
            name: react-static-files
        - name: shared-static
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: nginx-config
